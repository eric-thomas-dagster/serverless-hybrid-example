name: Deploy Serverless Location to Dagster+
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'code_locations/serverless-location/**'
      - '.github/workflows/deploy-serverless.yml'
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'code_locations/serverless-location/**'

concurrency:
  # Cancel in-progress runs on same branch
  group: ${{ github.ref }}/deploy-serverless
  cancel-in-progress: true

env:
  DAGSTER_CLOUD_API_TOKEN: ${{ secrets.DAGSTER_CLOUD_API_TOKEN }}
  DAGSTER_CLOUD_ORGANIZATION: ${{ secrets.DAGSTER_CLOUD_ORGANIZATION }}
  ENABLE_FAST_DEPLOYS: 'true'
  PYTHON_VERSION: '3.12'
  DAGSTER_CLOUD_YAML_PATH: './code_locations/serverless-location'
  DAGSTER_CLOUD_FILE: 'dagster_cloud.yaml'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  dagster_cloud_serverless_deploy:
    name: Dagster Serverless Deploy
    runs-on: ubuntu-22.04

    steps:
      - name: Prerun Checks
        id: prerun
        uses: dagster-io/dagster-cloud-action/actions/utils/prerun@v1.11.9

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Validate configuration
        id: ci-validate
        if: steps.prerun.outputs.result != 'skip'
        uses: dagster-io/dagster-cloud-action/actions/utils/dagster-cloud-cli@v1.11.9
        with:
          command: "ci check --project-dir ${{ env.DAGSTER_CLOUD_YAML_PATH }} --dagster-cloud-yaml-path ${{ env.DAGSTER_CLOUD_FILE }}"

      - name: Initialize build session
        id: ci-init
        uses: dagster-io/dagster-cloud-action/actions/utils/ci-init@v1.11.9
        with:
          project_dir: ${{ env.DAGSTER_CLOUD_YAML_PATH }}
          dagster_cloud_yaml_path: ${{ env.DAGSTER_CLOUD_FILE }}
          deployment: 'prod'

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        id: setup-python
        if: steps.prerun.outputs.result == 'pex-deploy'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install setuptools
        if: steps.prerun.outputs.result == 'pex-deploy'
        run: pip install setuptools
        shell: bash

      - name: Run PEX build
        id: run-pex-build
        if: steps.prerun.outputs.result == 'pex-deploy'
        uses: dagster-io/dagster-cloud-action/actions/utils/dagster-cloud-cli@v1.11.9
        with:
          command: "ci build --build-strategy=python-executable --python-version ${{ env.PYTHON_VERSION }}"

      - name: Deploy to Dagster Cloud
        id: ci-deploy
        if: steps.prerun.outputs.result != 'skip'
        uses: dagster-io/dagster-cloud-action/actions/utils/dagster-cloud-cli@v1.11.9
        with:
          command: "ci deploy"

      - name: Update PR comment
        id: ci-notify
        if: steps.prerun.outputs.result != 'skip'
        uses: dagster-io/dagster-cloud-action/actions/utils/dagster-cloud-cli@v1.11.9
        with:
          command: "ci notify --project-dir=${{ env.DAGSTER_CLOUD_YAML_PATH }}"

      - name: Generate summary
        id: ci-summary
        if: steps.prerun.outputs.result != 'skip'
        uses: dagster-io/dagster-cloud-action/actions/utils/dagster-cloud-cli@v1.11.9
        with:
          command: "ci status --output-format=markdown >> $GITHUB_STEP_SUMMARY"
